"use strict";const z=require("../../@babel/runtime/helpers/esm/extends.cjs"),W=require("../../@babel/runtime/helpers/esm/objectWithoutProperties.cjs"),U=require("../../@babel/runtime/helpers/esm/regeneratorRuntime.cjs"),G=require("../../@babel/runtime/helpers/esm/asyncToGenerator.cjs"),j=require("../../@babel/runtime/helpers/esm/objectSpread2.cjs"),K=require("../../@babel/runtime/helpers/esm/toConsumableArray.cjs"),B=require("../../@babel/runtime/helpers/esm/classCallCheck.cjs"),J=require("../../@babel/runtime/helpers/esm/createClass.cjs"),a=require("../../@babel/runtime/helpers/esm/assertThisInitialized.cjs"),Q=require("../../@babel/runtime/helpers/esm/inherits.cjs"),X=require("../../@babel/runtime/helpers/esm/createSuper.cjs"),i=require("../../@babel/runtime/helpers/esm/defineProperty.cjs"),Y=require("../../rc-util/es/Children/toArray.cjs"),I=require("../../rc-util/es/isEqual.cjs"),A=require("../../rc-util/es/warning.cjs"),Z=require("react"),H=require("./FieldContext.cjs"),$=require("./ListContext.cjs"),S=require("./utils/typeUtil.cjs"),ee=require("./utils/validateUtil.cjs"),M=require("./utils/valueUtil.cjs"),te=require("../../rc-util/es/utils/get.cjs");function re(g){const m=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(g){for(const c in g)if(c!=="default"){const o=Object.getOwnPropertyDescriptor(g,c);Object.defineProperty(m,c,o.get?o:{enumerable:!0,get:()=>g[c]})}}return m.default=g,Object.freeze(m)}const q=re(Z);var ne=["name"],h=[];function L(g,m,c,o,e,r){return typeof g=="function"?g(m,c,"source"in r?{source:r.source}:{}):o!==e}var T=function(g){Q(c,g);var m=X(c);function c(o){var e;return B(this,c),e=m.call(this,o),i(a(e),"state",{resetCount:0}),i(a(e),"cancelRegisterFunc",null),i(a(e),"mounted",!1),i(a(e),"touched",!1),i(a(e),"dirty",!1),i(a(e),"validatePromise",void 0),i(a(e),"prevValidating",void 0),i(a(e),"errors",h),i(a(e),"warnings",h),i(a(e),"cancelRegister",function(){var r=e.props,n=r.preserve,t=r.isListField,l=r.name;e.cancelRegisterFunc&&e.cancelRegisterFunc(t,n,M.getNamePath(l)),e.cancelRegisterFunc=null}),i(a(e),"getNamePath",function(){var r=e.props,n=r.name,t=r.fieldContext.prefixName;return n!==void 0?[].concat(K(t===void 0?[]:t),K(n)):[]}),i(a(e),"getRules",function(){var r=e.props,n=r.rules,t=n===void 0?[]:n,l=r.fieldContext;return t.map(function(u){return typeof u=="function"?u(l):u})}),i(a(e),"refresh",function(){e.mounted&&e.setState(function(r){return{resetCount:r.resetCount+1}})}),i(a(e),"metaCache",null),i(a(e),"triggerMetaEvent",function(r){var n=e.props.onMetaChange;if(n){var t=j(j({},e.getMeta()),{},{destroy:r});I(e.metaCache,t)||n(t),e.metaCache=t}else e.metaCache=null}),i(a(e),"onStoreChange",function(r,n,t){var l=e.props,u=l.shouldUpdate,V=l.dependencies,x=V===void 0?[]:V,P=l.onReset,O=t.store,v=e.getNamePath(),F=e.getValue(r),C=e.getValue(O),N=n&&M.containsNamePath(n,v);switch(t.type!=="valueUpdate"||t.source!=="external"||I(F,C)||(e.touched=!0,e.dirty=!0,e.validatePromise=null,e.errors=h,e.warnings=h,e.triggerMetaEvent()),t.type){case"reset":if(!n||N)return e.touched=!1,e.dirty=!1,e.validatePromise=void 0,e.errors=h,e.warnings=h,e.triggerMetaEvent(),P==null||P(),void e.refresh();break;case"remove":if(u&&L(u,r,O,F,C,t))return void e.reRender();break;case"setField":var d=t.data;if(N)return"touched"in d&&(e.touched=d.touched),"validating"in d&&!("originRCField"in d)&&(e.validatePromise=d.validating?Promise.resolve([]):null),"errors"in d&&(e.errors=d.errors||h),"warnings"in d&&(e.warnings=d.warnings||h),e.dirty=!0,e.triggerMetaEvent(),void e.reRender();if("value"in d&&M.containsNamePath(n,v,!0)||u&&!v.length&&L(u,r,O,F,C,t))return void e.reRender();break;case"dependenciesUpdate":if(x.map(M.getNamePath).some(function(R){return M.containsNamePath(t.relatedFields,R)}))return void e.reRender();break;default:if(N||(!x.length||v.length||u)&&L(u,r,O,F,C,t))return void e.reRender()}u===!0&&e.reRender()}),i(a(e),"validateRules",function(r){var n=e.getNamePath(),t=e.getValue(),l=r||{},u=l.triggerName,V=l.validateOnly,x=V!==void 0&&V,P=Promise.resolve().then(G(U().mark(function O(){var v,F,C,N,d,R,_;return U().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(e.mounted){f.next=2;break}return f.abrupt("return",[]);case 2:if(v=e.props,F=v.validateFirst,C=F!==void 0&&F,N=v.messageVariables,d=v.validateDebounce,R=e.getRules(),u&&(R=R.filter(function(p){return p}).filter(function(p){var y=p.validateTrigger;return!y||S.toArray(y).includes(u)})),!d||!u){f.next=10;break}return f.next=8,new Promise(function(p){setTimeout(p,d)});case 8:if(e.validatePromise===P){f.next=10;break}return f.abrupt("return",[]);case 10:return(_=ee.validateRules(n,t,R,r,C,N)).catch(function(p){return p}).then(function(){var p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:h;if(e.validatePromise===P){var y;e.validatePromise=null;var b=[],s=[];(y=p.forEach)===null||y===void 0||y.call(p,function(w){var E=w.rule.warningOnly,k=w.errors,D=k===void 0?h:k;E?s.push.apply(s,K(D)):b.push.apply(b,K(D))}),e.errors=b,e.warnings=s,e.triggerMetaEvent(),e.reRender()}}),f.abrupt("return",_);case 13:case"end":return f.stop()}},O)})));return x||(e.validatePromise=P,e.dirty=!0,e.errors=h,e.warnings=h,e.triggerMetaEvent(),e.reRender()),P}),i(a(e),"isFieldValidating",function(){return!!e.validatePromise}),i(a(e),"isFieldTouched",function(){return e.touched}),i(a(e),"isFieldDirty",function(){return!(!e.dirty&&e.props.initialValue===void 0)||(0,e.props.fieldContext.getInternalHooks(H.HOOK_MARK).getInitialValue)(e.getNamePath())!==void 0}),i(a(e),"getErrors",function(){return e.errors}),i(a(e),"getWarnings",function(){return e.warnings}),i(a(e),"isListField",function(){return e.props.isListField}),i(a(e),"isList",function(){return e.props.isList}),i(a(e),"isPreserve",function(){return e.props.preserve}),i(a(e),"getMeta",function(){return e.prevValidating=e.isFieldValidating(),{touched:e.isFieldTouched(),validating:e.prevValidating,errors:e.errors,warnings:e.warnings,name:e.getNamePath(),validated:e.validatePromise===null}}),i(a(e),"getOnlyChild",function(r){if(typeof r=="function"){var n=e.getMeta();return j(j({},e.getOnlyChild(r(e.getControlled(),n,e.props.fieldContext))),{},{isFunction:!0})}var t=Y(r);return t.length===1&&q.isValidElement(t[0])?{child:t[0],isFunction:!1}:{child:t,isFunction:!1}}),i(a(e),"getValue",function(r){var n=e.props.fieldContext.getFieldsValue,t=e.getNamePath();return te(r||n(!0),t)}),i(a(e),"getControlled",function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},n=e.props,t=n.name,l=n.trigger,u=n.validateTrigger,V=n.getValueFromEvent,x=n.normalize,P=n.valuePropName,O=n.getValueProps,v=n.fieldContext,F=u!==void 0?u:v.validateTrigger,C=e.getNamePath(),N=v.getInternalHooks,d=v.getFieldsValue,R=N(H.HOOK_MARK).dispatch,_=e.getValue(),f=O||function(s){return i({},P,s)},p=r[l],y=t!==void 0?f(_):{};process.env.NODE_ENV!=="production"&&y&&Object.keys(y).forEach(function(s){A.warningOnce(typeof y[s]!="function","It's not recommended to generate dynamic function prop by `getValueProps`. Please pass it to child component directly (prop: ".concat(s,")"))});var b=j(j({},r),y);return b[l]=function(){var s;e.touched=!0,e.dirty=!0,e.triggerMetaEvent();for(var w=arguments.length,E=new Array(w),k=0;k<w;k++)E[k]=arguments[k];s=V?V.apply(void 0,E):M.defaultGetValueFromEvent.apply(void 0,[P].concat(E)),x&&(s=x(s,_,d(!0))),s!==_&&R({type:"updateValue",namePath:C,value:s}),p&&p.apply(void 0,E)},S.toArray(F||[]).forEach(function(s){var w=b[s];b[s]=function(){w&&w.apply(void 0,arguments);var E=e.props.rules;E&&E.length&&R({type:"validateField",namePath:C,triggerName:s})}}),b}),o.fieldContext&&(0,(0,o.fieldContext.getInternalHooks)(H.HOOK_MARK).initEntityValue)(a(e)),e}return J(c,[{key:"componentDidMount",value:function(){var o=this.props,e=o.shouldUpdate,r=o.fieldContext;if(this.mounted=!0,r){var n=(0,r.getInternalHooks)(H.HOOK_MARK).registerField;this.cancelRegisterFunc=n(this)}e===!0&&this.reRender()}},{key:"componentWillUnmount",value:function(){this.cancelRegister(),this.triggerMetaEvent(!0),this.mounted=!1}},{key:"reRender",value:function(){this.mounted&&this.forceUpdate()}},{key:"render",value:function(){var o,e=this.state.resetCount,r=this.props.children,n=this.getOnlyChild(r),t=n.child;return n.isFunction?o=t:q.isValidElement(t)?o=q.cloneElement(t,this.getControlled(t.props)):(A.warningOnce(!t,"`children` of Field is not validate ReactElement."),o=t),q.createElement(q.Fragment,{key:e},o)}}]),c}(q.Component);i(T,"contextType",H.default),i(T,"defaultProps",{trigger:"onChange",valuePropName:"value"}),module.exports=function(g){var m,c=g.name,o=W(g,ne),e=q.useContext(H.default),r=q.useContext($),n=c!==void 0?M.getNamePath(c):void 0,t=(m=o.isListField)!==null&&m!==void 0?m:!!r,l="keep";return t||(l="_".concat((n||[]).join("_"))),process.env.NODE_ENV!=="production"&&o.preserve===!1&&t&&n.length<=1&&A.warningOnce(!1,"`preserve` should not apply on Form.List fields."),q.createElement(T,z({key:l,name:n,isListField:t},o,{fieldContext:e}))};
