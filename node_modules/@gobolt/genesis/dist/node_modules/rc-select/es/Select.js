import to from "../../@babel/runtime/helpers/esm/extends.js";
import d from "../../@babel/runtime/helpers/esm/toConsumableArray.js";
import xe from "../../@babel/runtime/helpers/esm/defineProperty.js";
import g from "../../@babel/runtime/helpers/esm/objectSpread2.js";
import f from "../../@babel/runtime/helpers/esm/slicedToArray.js";
import no from "../../@babel/runtime/helpers/esm/objectWithoutProperties.js";
import ro from "../../@babel/runtime/helpers/esm/typeof.js";
import Me from "../../rc-util/es/hooks/useMergedState.js";
import { warningOnce as io } from "../../rc-util/es/warning.js";
import * as l from "react";
import lo, { isMultiple as Ie } from "./BaseSelect/index.js";
import ao from "./OptGroup.js";
import uo from "./Option.js";
import co from "./OptionList.js";
import so from "./SelectContext.js";
import mo from "./hooks/useCache.js";
import vo from "./hooks/useFilterOptions.js";
import po from "./hooks/useId.js";
import fo from "./hooks/useOptions.js";
import ke from "./hooks/useRefFunc.js";
import { toArray as bo, isComboNoValue as ho, hasValue as go } from "./utils/commonUtil.js";
import { fillFieldNames as So, flattenOptions as Vo, injectPropsWithOption as we } from "./utils/valueUtil.js";
import Oo, { warningNullOptions as yo } from "./utils/warningPropsUtil.js";
var Co = ["id", "mode", "prefixCls", "backfill", "fieldNames", "inputValue", "searchValue", "onSearch", "autoClearSearchValue", "onSelect", "onDeselect", "dropdownMatchSelectWidth", "filterOption", "filterSort", "optionFilterProp", "optionLabelProp", "options", "optionRender", "children", "defaultActiveFirstOption", "menuItemSelectedIcon", "virtual", "direction", "listHeight", "listItemHeight", "labelRender", "value", "defaultValue", "labelInValue", "onChange", "maxCount"], No = ["inputValue"], De = l.forwardRef(function(n, Pe) {
  var Fe = n.id, a = n.mode, K = n.prefixCls, He = K === void 0 ? "rc-select" : K, Q = n.backfill, T = n.fieldNames, Re = n.inputValue, U = n.searchValue, X = n.onSearch, Y = n.autoClearSearchValue, Z = Y === void 0 || Y, $ = n.onSelect, ee = n.onDeselect, oe = n.dropdownMatchSelectWidth, R = oe === void 0 || oe, _ = n.filterOption, W = n.filterSort, M = n.optionFilterProp, I = n.optionLabelProp, te = n.options, ne = n.optionRender, re = n.children, ie = n.defaultActiveFirstOption, le = n.menuItemSelectedIcon, ae = n.virtual, L = n.direction, ue = n.listHeight, ce = ue === void 0 ? 200 : ue, se = n.listItemHeight, me = se === void 0 ? 20 : se, j = n.labelRender, _e = n.value, We = n.defaultValue, ve = n.labelInValue, de = n.onChange, pe = n.maxCount, Le = no(n, Co), fe = po(Fe), b = Ie(a), h = !(te || !re), je = l.useMemo(function() {
    return (_ !== void 0 || a !== "combobox") && _;
  }, [_, a]), u = l.useMemo(function() {
    return So(T, h);
  }, [JSON.stringify(T), h]), Ge = Me("", { value: U !== void 0 ? U : Re, postState: function(e) {
    return e || "";
  } }), be = f(Ge, 2), m = be[0], k = be[1], S = fo(te, re, u, M, I), V = S.valueOptions, Je = S.labelOptions, w = S.options, G = l.useCallback(function(e) {
    return bo(e).map(function(o) {
      var t, r, i, p, v, C;
      (function(H) {
        return !H || ro(H) !== "object";
      })(o) ? t = o : (i = o.key, r = o.label, t = (C = o.value) !== null && C !== void 0 ? C : i);
      var N, s = V.get(t);
      if (s && (r === void 0 && (r = s == null ? void 0 : s[I || u.label]), i === void 0 && (i = (N = s == null ? void 0 : s.key) !== null && N !== void 0 ? N : t), p = s == null ? void 0 : s.disabled, v = s == null ? void 0 : s.title, process.env.NODE_ENV !== "production" && !I)) {
        var E = s == null ? void 0 : s[u.label];
        E === void 0 || l.isValidElement(E) || l.isValidElement(r) || E === r || io(!1, "`label` of `value` is not same as `label` in Select options.");
      }
      return { label: r, value: t, key: i, disabled: p, title: v };
    });
  }, [u, I, V]), qe = Me(We, { value: _e }), he = f(qe, 2), J = he[0], ze = he[1], Be = l.useMemo(function() {
    var e, o = G(b && J === null ? [] : J);
    return a === "combobox" && ho((e = o[0]) === null || e === void 0 ? void 0 : e.value) ? [] : o;
  }, [J, G, a, b]), Ke = mo(Be, V), ge = f(Ke, 2), c = ge[0], Se = ge[1], Qe = l.useMemo(function() {
    if (!a && c.length === 1) {
      var e = c[0];
      if (e.value === null && (e.label === null || e.label === void 0)) return [];
    }
    return c.map(function(o) {
      var t;
      return g(g({}, o), {}, { label: (t = typeof j == "function" ? j(o) : o.label) !== null && t !== void 0 ? t : o.value });
    });
  }, [a, c, j]), A = l.useMemo(function() {
    return new Set(c.map(function(e) {
      return e.value;
    }));
  }, [c]);
  l.useEffect(function() {
    if (a === "combobox") {
      var e, o = (e = c[0]) === null || e === void 0 ? void 0 : e.value;
      k(go(o) ? String(o) : "");
    }
  }, [c]);
  var D = ke(function(e, o) {
    var t = o ?? e;
    return xe(xe({}, u.value, e), u.label, t);
  }), Te = l.useMemo(function() {
    if (a !== "tags") return w;
    var e = d(w);
    return d(c).sort(function(o, t) {
      return o.value < t.value ? -1 : 1;
    }).forEach(function(o) {
      var t = o.value;
      (function(r) {
        return V.has(r);
      })(t) || e.push(D(t, o.label));
    }), e;
  }, [D, w, V, c, a]), O = vo(Te, u, m, je, M), q = l.useMemo(function() {
    return a !== "tags" || !m || O.some(function(e) {
      return e[M || "value"] === m;
    }) || O.some(function(e) {
      return e[u.value] === m;
    }) ? O : [D(m)].concat(d(O));
  }, [D, M, a, O, m, u]), Ue = function e(o) {
    return d(o).sort(function(t, r) {
      return W(t, r, { searchValue: m });
    }).map(function(t) {
      return Array.isArray(t.options) ? g(g({}, t), {}, { options: t.options.length > 0 ? e(t.options) : t.options }) : t;
    });
  }, Ve = l.useMemo(function() {
    return W ? Ue(q) : q;
  }, [q, W, m]), z = l.useMemo(function() {
    return Vo(Ve, { fieldNames: u, childrenAsData: h });
  }, [Ve, u, h]), y = function(e) {
    var o = G(e);
    if (ze(o), de && (o.length !== c.length || o.some(function(i, p) {
      var v;
      return ((v = c[p]) === null || v === void 0 ? void 0 : v.value) !== (i == null ? void 0 : i.value);
    }))) {
      var t = ve ? o : o.map(function(i) {
        return i.value;
      }), r = o.map(function(i) {
        return we(Se(i.value));
      });
      de(b ? t : t[0], b ? r : r[0]);
    }
  }, Xe = l.useState(null), Oe = f(Xe, 2), Ye = Oe[0], P = Oe[1], Ze = l.useState(0), ye = f(Ze, 2), $e = ye[0], eo = ye[1], Ce = ie !== void 0 ? ie : a !== "combobox", Ne = l.useCallback(function(e, o) {
    var t = (arguments.length > 2 && arguments[2] !== void 0 ? arguments[2] : {}).source, r = t === void 0 ? "keyboard" : t;
    eo(o), Q && a === "combobox" && e !== null && r === "keyboard" && P(String(e));
  }, [Q, a]), F = function(e, o, t) {
    var r = function() {
      var B, x = Se(e);
      return [ve ? { label: x == null ? void 0 : x[u.label], value: e, key: (B = x == null ? void 0 : x.key) !== null && B !== void 0 ? B : e } : e, we(x)];
    };
    if (o && $) {
      var i = r(), p = f(i, 2), v = p[0], C = p[1];
      $(v, C);
    } else if (!o && ee && t !== "clear") {
      var N = r(), s = f(N, 2), E = s[0], H = s[1];
      ee(E, H);
    }
  }, Ee = ke(function(e, o) {
    var t, r = !b || o.selected;
    t = r ? b ? [].concat(d(c), [e]) : [e] : c.filter(function(i) {
      return i.value !== e;
    }), y(t), F(e, r), a === "combobox" ? P("") : Ie && !Z || (k(""), P(""));
  }), oo = l.useMemo(function() {
    var e = ae !== !1 && R !== !1;
    return g(g({}, S), {}, { flattenOptions: z, onActiveValue: Ne, defaultActiveFirstOption: Ce, onSelect: Ee, menuItemSelectedIcon: le, rawValues: A, fieldNames: u, virtual: e, direction: L, listHeight: ce, listItemHeight: me, childrenAsData: h, maxCount: pe, optionRender: ne });
  }, [pe, S, z, Ne, Ce, Ee, le, A, u, ae, R, L, ce, me, h, ne]);
  return process.env.NODE_ENV !== "production" && (Oo(n), yo(w, u)), l.createElement(so.Provider, { value: oo }, l.createElement(lo, to({}, Le, { id: fe, prefixCls: He, ref: Pe, omitDomProps: No, mode: a, displayValues: Qe, onDisplayValuesChange: function(e, o) {
    y(e);
    var t = o.type, r = o.values;
    t !== "remove" && t !== "clear" || r.forEach(function(i) {
      F(i.value, !1, t);
    });
  }, direction: L, searchValue: m, onSearch: function(e, o) {
    if (k(e), P(null), o.source !== "submit") o.source !== "blur" && (a === "combobox" && y(e), X == null || X(e));
    else {
      var t = (e || "").trim();
      if (t) {
        var r = Array.from(new Set([].concat(d(A), [t])));
        y(r), F(t, !0), k("");
      }
    }
  }, autoClearSearchValue: Z, onSearchSplit: function(e) {
    var o = e;
    a !== "tags" && (o = e.map(function(r) {
      var i = Je.get(r);
      return i == null ? void 0 : i.value;
    }).filter(function(r) {
      return r !== void 0;
    }));
    var t = Array.from(new Set([].concat(d(A), d(o))));
    y(t), t.forEach(function(r) {
      F(r, !0);
    });
  }, dropdownMatchSelectWidth: R, OptionList: co, emptyOptions: !z.length, activeValue: Ye, activeDescendantId: "".concat(fe, "_list_").concat($e) })));
});
process.env.NODE_ENV !== "production" && (De.displayName = "Select");
var Ae = De;
Ae.Option = uo, Ae.OptGroup = ao;
export {
  Ae as default
};
