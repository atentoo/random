import rt from "../../../@babel/runtime/helpers/esm/typeof.js";
import et from "../../../@babel/runtime/helpers/esm/slicedToArray.js";
import { useContext as M } from "../../../@rc-component/context/es/context.js";
import "../../../rc-util/es/ref.js";
import * as i from "react";
import nt from "../../../rc-virtual-list/es/List.js";
import ot, { responseImmutable as it } from "../context/TableContext.js";
import lt from "../hooks/useFlattenRecords.js";
import T from "./BodyLine.js";
import { StaticContext as ut, GridContext as ct } from "./context.js";
var at = it(i.forwardRef(function(R, O) {
  var j = R.data, L = R.onScroll, l = M(ot, ["flattenColumns", "onColumnResize", "getRowKey", "prefixCls", "expandedKeys", "childrenColumnName", "scrollX", "direction"]), s = l.flattenColumns, G = l.onColumnResize, m = l.getRowKey, P = l.expandedKeys, V = l.prefixCls, X = l.childrenColumnName, Y = l.scrollX, B = l.direction, d = M(ut), y = d.sticky, D = d.scrollY, W = d.listItemHeight, _ = d.getComponent, q = d.onScroll, c = i.useRef(), a = lt(j, X, P, m), g = i.useMemo(function() {
    var r = 0;
    return s.map(function(e) {
      var t = e.width;
      return [e.key, t, r += t];
    });
  }, [s]), b = i.useMemo(function() {
    return g.map(function(r) {
      return r[2];
    });
  }, [g]);
  i.useEffect(function() {
    g.forEach(function(r) {
      var e = et(r, 2), t = e[0], o = e[1];
      G(t, o);
    });
  }, [g]), i.useImperativeHandle(O, function() {
    var r, e = { scrollTo: function(t) {
      var o;
      (o = c.current) === null || o === void 0 || o.scrollTo(t);
    }, nativeElement: (r = c.current) === null || r === void 0 ? void 0 : r.nativeElement };
    return Object.defineProperty(e, "scrollLeft", { get: function() {
      var t;
      return ((t = c.current) === null || t === void 0 ? void 0 : t.getScrollInfo().x) || 0;
    }, set: function(t) {
      var o;
      (o = c.current) === null || o === void 0 || o.scrollTo({ left: t });
    } }), e;
  });
  var v = function(r, e) {
    var t, o = (t = a[e]) === null || t === void 0 ? void 0 : t.record, x = r.onCell;
    if (x) {
      var f, p = x(o, e);
      return (f = p == null ? void 0 : p.rowSpan) !== null && f !== void 0 ? f : 1;
    }
    return 1;
  }, A = i.useMemo(function() {
    return { columnsOffset: b };
  }, [b]), K = "".concat(V, "-tbody"), F = _(["body", "wrapper"]), h = {};
  return y && (h.position = "sticky", h.bottom = 0, rt(y) === "object" && y.offsetScroll && (h.bottom = y.offsetScroll)), i.createElement(ct.Provider, { value: A }, i.createElement(nt, { fullHeight: !1, ref: c, prefixCls: "".concat(K, "-virtual"), styles: { horizontalScrollBar: h }, className: K, height: D, itemHeight: W || 24, data: a, itemKey: function(r) {
    return m(r.record);
  }, component: F, scrollWidth: Y, direction: B, onVirtualScroll: function(r) {
    var e, t = r.x;
    L({ currentTarget: (e = c.current) === null || e === void 0 ? void 0 : e.nativeElement, scrollLeft: t });
  }, onScroll: q, extraRender: function(r) {
    var e = r.start, t = r.end, o = r.getSize, x = r.offsetY;
    if (t < 0) return null;
    for (var f = s.filter(function(n) {
      return v(n, e) === 0;
    }), p = e, J = function(n) {
      if (!(f = f.filter(function(u) {
        return v(u, n) === 0;
      })).length) return p = n, 1;
    }, C = e; C >= 0 && !J(C); C -= 1) ;
    for (var N = s.filter(function(n) {
      return v(n, t) !== 1;
    }), H = t, Q = function(n) {
      if (!(N = N.filter(function(u) {
        return v(u, n) !== 1;
      })).length) return H = Math.max(n - 1, t), 1;
    }, S = t; S < a.length && !Q(S); S += 1) ;
    for (var k = [], U = function(n) {
      if (!a[n]) return 1;
      s.some(function(u) {
        return v(u, n) > 1;
      }) && k.push(n);
    }, E = p; E <= H; E += 1) U(E);
    return k.map(function(n) {
      var u = a[n], w = m(u.record, n), Z = o(w);
      return i.createElement(T, { key: n, data: u, rowKey: w, index: n, style: { top: -x + Z.top }, extra: !0, getHeight: function($) {
        var z = n + $ - 1, tt = m(a[z].record, z), I = o(w, tt);
        return I.bottom - I.top;
      } });
    });
  } }, function(r, e, t) {
    var o = m(r.record, e);
    return i.createElement(T, { data: r, rowKey: o, index: e, style: t.style });
  }));
}));
process.env.NODE_ENV !== "production" && (at.displayName = "ResponseGrid");
export {
  at as default
};
