"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const C=require("../../@babel/runtime/helpers/esm/slicedToArray.cjs"),E=require("../../@babel/runtime/helpers/esm/objectSpread2.cjs"),j=require("../../@babel/runtime/helpers/esm/objectWithoutProperties.cjs"),P=require("../../@babel/runtime/helpers/esm/toConsumableArray.cjs"),_=require("../../@babel/runtime/helpers/esm/typeof.cjs"),H=require("../../@babel/runtime/helpers/esm/createClass.cjs"),R=require("../../@babel/runtime/helpers/esm/classCallCheck.cjs"),a=require("../../@babel/runtime/helpers/esm/defineProperty.cjs"),v=require("../../rc-util/es/utils/set.cjs"),S=require("../../rc-util/es/warning.cjs"),x=require("react"),z=require("./FieldContext.cjs"),B=require("./utils/asyncUtil.cjs"),K=require("./utils/messages.cjs"),b=require("./utils/NameMap.cjs"),h=require("./utils/valueUtil.cjs"),A=require("../../rc-util/es/utils/get.cjs");function G(m){const F=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(m){for(const e in m)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(m,e);Object.defineProperty(F,e,t.get?t:{enumerable:!0,get:()=>m[e]})}}return F.default=m,Object.freeze(F)}const T=G(x);var J=["name"],q=H(function m(F){var e=this;R(this,m),a(this,"formHooked",!1),a(this,"forceRootUpdate",void 0),a(this,"subscribable",!0),a(this,"store",{}),a(this,"fieldEntities",[]),a(this,"initialValues",{}),a(this,"callbacks",{}),a(this,"validateMessages",null),a(this,"preserve",null),a(this,"lastValidatePromise",null),a(this,"getForm",function(){return{getFieldValue:e.getFieldValue,getFieldsValue:e.getFieldsValue,getFieldError:e.getFieldError,getFieldWarning:e.getFieldWarning,getFieldsError:e.getFieldsError,isFieldsTouched:e.isFieldsTouched,isFieldTouched:e.isFieldTouched,isFieldValidating:e.isFieldValidating,isFieldsValidating:e.isFieldsValidating,resetFields:e.resetFields,setFields:e.setFields,setFieldValue:e.setFieldValue,setFieldsValue:e.setFieldsValue,validateFields:e.validateFields,submit:e.submit,_init:!0,getInternalHooks:e.getInternalHooks}}),a(this,"getInternalHooks",function(t){return t===z.HOOK_MARK?(e.formHooked=!0,{dispatch:e.dispatch,initEntityValue:e.initEntityValue,registerField:e.registerField,useSubscribe:e.useSubscribe,setInitialValues:e.setInitialValues,destroyForm:e.destroyForm,setCallbacks:e.setCallbacks,setValidateMessages:e.setValidateMessages,getFields:e.getFields,setPreserve:e.setPreserve,getInitialValue:e.getInitialValue,registerWatch:e.registerWatch}):(S.warningOnce(!1,"`getInternalHooks` is internal usage. Should not call directly."),null)}),a(this,"useSubscribe",function(t){e.subscribable=t}),a(this,"prevWithoutPreserves",null),a(this,"setInitialValues",function(t,i){if(e.initialValues=t||{},i){var r,n=v.merge(t,e.store);(r=e.prevWithoutPreserves)===null||r===void 0||r.map(function(o){var l=o.key;n=v.default(n,l,A(t,l))}),e.prevWithoutPreserves=null,e.updateStore(n)}}),a(this,"destroyForm",function(t){if(t)e.updateStore({});else{var i=new b;e.getFieldEntities(!0).forEach(function(r){e.isMergedPreserve(r.isPreserve())||i.set(r.getNamePath(),!0)}),e.prevWithoutPreserves=i}}),a(this,"getInitialValue",function(t){var i=A(e.initialValues,t);return t.length?v.merge(i):i}),a(this,"setCallbacks",function(t){e.callbacks=t}),a(this,"setValidateMessages",function(t){e.validateMessages=t}),a(this,"setPreserve",function(t){e.preserve=t}),a(this,"watchList",[]),a(this,"registerWatch",function(t){return e.watchList.push(t),function(){e.watchList=e.watchList.filter(function(i){return i!==t})}}),a(this,"notifyWatch",function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];if(e.watchList.length){var i=e.getFieldsValue(),r=e.getFieldsValue(!0);e.watchList.forEach(function(n){n(i,r,t)})}}),a(this,"timeoutId",null),a(this,"warningUnhooked",function(){process.env.NODE_ENV==="production"||e.timeoutId||typeof window>"u"||(e.timeoutId=setTimeout(function(){e.timeoutId=null,e.formHooked||S.warningOnce(!1,"Instance created by `useForm` is not connected to any Form element. Forget to pass `form` prop?")}))}),a(this,"updateStore",function(t){e.store=t}),a(this,"getFieldEntities",function(){return arguments.length>0&&arguments[0]!==void 0&&arguments[0]?e.fieldEntities.filter(function(t){return t.getNamePath().length}):e.fieldEntities}),a(this,"getFieldsMap",function(){var t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=new b;return e.getFieldEntities(t).forEach(function(r){var n=r.getNamePath();i.set(n,r)}),i}),a(this,"getFieldEntitiesForNamePathList",function(t){if(!t)return e.getFieldEntities(!0);var i=e.getFieldsMap(!0);return t.map(function(r){var n=h.getNamePath(r);return i.get(n)||{INVALIDATE_NAME_PATH:h.getNamePath(r)}})}),a(this,"getFieldsValue",function(t,i){var r,n,o;if(e.warningUnhooked(),t===!0||Array.isArray(t)?(r=t,n=i):t&&_(t)==="object"&&(o=t.strict,n=t.filter),r===!0&&!n)return e.store;var l=e.getFieldEntitiesForNamePathList(Array.isArray(r)?r:null),s=[];return l.forEach(function(u){var g,p,y,V,d="INVALIDATE_NAME_PATH"in u?u.INVALIDATE_NAME_PATH:u.getNamePath();if(o){if((y=(V=u).isList)!==null&&y!==void 0&&y.call(V))return}else if(!r&&(g=(p=u).isListField)!==null&&g!==void 0&&g.call(p))return;if(n){var w="getMeta"in u?u.getMeta():null;n(w)&&s.push(d)}else s.push(d)}),h.cloneByNamePathList(e.store,s.map(h.getNamePath))}),a(this,"getFieldValue",function(t){e.warningUnhooked();var i=h.getNamePath(t);return A(e.store,i)}),a(this,"getFieldsError",function(t){return e.warningUnhooked(),e.getFieldEntitiesForNamePathList(t).map(function(i,r){return i&&!("INVALIDATE_NAME_PATH"in i)?{name:i.getNamePath(),errors:i.getErrors(),warnings:i.getWarnings()}:{name:h.getNamePath(t[r]),errors:[],warnings:[]}})}),a(this,"getFieldError",function(t){e.warningUnhooked();var i=h.getNamePath(t);return e.getFieldsError([i])[0].errors}),a(this,"getFieldWarning",function(t){e.warningUnhooked();var i=h.getNamePath(t);return e.getFieldsError([i])[0].warnings}),a(this,"isFieldsTouched",function(){e.warningUnhooked();for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];var n,o=i[0],l=i[1],s=!1;i.length===0?n=null:i.length===1?Array.isArray(o)?(n=o.map(h.getNamePath),s=!1):(n=null,s=o):(n=o.map(h.getNamePath),s=l);var u=e.getFieldEntities(!0),g=function(d){return d.isFieldTouched()};if(!n)return s?u.every(function(d){return g(d)||d.isList()}):u.some(g);var p=new b;n.forEach(function(d){p.set(d,[])}),u.forEach(function(d){var w=d.getNamePath();n.forEach(function(I){I.every(function(c,f){return w[f]===c})&&p.update(I,function(c){return[].concat(P(c),[d])})})});var y=function(d){return d.some(g)},V=p.map(function(d){return d.value});return s?V.every(y):V.some(y)}),a(this,"isFieldTouched",function(t){return e.warningUnhooked(),e.isFieldsTouched([t])}),a(this,"isFieldsValidating",function(t){e.warningUnhooked();var i=e.getFieldEntities();if(!t)return i.some(function(n){return n.isFieldValidating()});var r=t.map(h.getNamePath);return i.some(function(n){var o=n.getNamePath();return h.containsNamePath(r,o)&&n.isFieldValidating()})}),a(this,"isFieldValidating",function(t){return e.warningUnhooked(),e.isFieldsValidating([t])}),a(this,"resetWithFieldInitialValue",function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},i=new b,r=e.getFieldEntities(!0);r.forEach(function(o){var l=o.props.initialValue,s=o.getNamePath();if(l!==void 0){var u=i.get(s)||new Set;u.add({entity:o,value:l}),i.set(s,u)}});var n;t.entities?n=t.entities:t.namePathList?(n=[],t.namePathList.forEach(function(o){var l,s=i.get(o);s&&(l=n).push.apply(l,P(P(s).map(function(u){return u.entity})))})):n=r,n.forEach(function(o){if(o.props.initialValue!==void 0){var l=o.getNamePath();if(e.getInitialValue(l)!==void 0)S.warningOnce(!1,"Form already set 'initialValues' with path '".concat(l.join("."),"'. Field can not overwrite it."));else{var s=i.get(l);if(s&&s.size>1)S.warningOnce(!1,"Multiple Field with path '".concat(l.join("."),"' set 'initialValue'. Can not decide which one to pick."));else if(s){var u=e.getFieldValue(l);o.isListField()||t.skipExist&&u!==void 0||e.updateStore(v.default(e.store,l,P(s)[0].value))}}}})}),a(this,"resetFields",function(t){e.warningUnhooked();var i=e.store;if(!t)return e.updateStore(v.merge(e.initialValues)),e.resetWithFieldInitialValue(),e.notifyObservers(i,null,{type:"reset"}),void e.notifyWatch();var r=t.map(h.getNamePath);r.forEach(function(n){var o=e.getInitialValue(n);e.updateStore(v.default(e.store,n,o))}),e.resetWithFieldInitialValue({namePathList:r}),e.notifyObservers(i,r,{type:"reset"}),e.notifyWatch(r)}),a(this,"setFields",function(t){e.warningUnhooked();var i=e.store,r=[];t.forEach(function(n){var o=n.name,l=j(n,J),s=h.getNamePath(o);r.push(s),"value"in l&&e.updateStore(v.default(e.store,s,l.value)),e.notifyObservers(i,[s],{type:"setField",data:n})}),e.notifyWatch(r)}),a(this,"getFields",function(){return e.getFieldEntities(!0).map(function(t){var i=t.getNamePath(),r=t.getMeta(),n=E(E({},r),{},{name:i,value:e.getFieldValue(i)});return Object.defineProperty(n,"originRCField",{value:!0}),n})}),a(this,"initEntityValue",function(t){var i=t.props.initialValue;if(i!==void 0){var r=t.getNamePath();A(e.store,r)===void 0&&e.updateStore(v.default(e.store,r,i))}}),a(this,"isMergedPreserve",function(t){var i=t!==void 0?t:e.preserve;return i==null||i}),a(this,"registerField",function(t){e.fieldEntities.push(t);var i=t.getNamePath();if(e.notifyWatch([i]),t.props.initialValue!==void 0){var r=e.store;e.resetWithFieldInitialValue({entities:[t],skipExist:!0}),e.notifyObservers(r,[t.getNamePath()],{type:"valueUpdate",source:"internal"})}return function(n,o){var l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];if(e.fieldEntities=e.fieldEntities.filter(function(g){return g!==t}),!e.isMergedPreserve(o)&&(!n||l.length>1)){var s=n?void 0:e.getInitialValue(i);if(i.length&&e.getFieldValue(i)!==s&&e.fieldEntities.every(function(g){return!h.matchNamePath(g.getNamePath(),i)})){var u=e.store;e.updateStore(v.default(u,i,s,!0)),e.notifyObservers(u,[i],{type:"remove"}),e.triggerDependenciesUpdate(u,i)}}e.notifyWatch([i])}}),a(this,"dispatch",function(t){switch(t.type){case"updateValue":var i=t.namePath,r=t.value;e.updateValue(i,r);break;case"validateField":var n=t.namePath,o=t.triggerName;e.validateFields([n],{triggerName:o})}}),a(this,"notifyObservers",function(t,i,r){if(e.subscribable){var n=E(E({},r),{},{store:e.getFieldsValue(!0)});e.getFieldEntities().forEach(function(o){(0,o.onStoreChange)(t,i,n)})}else e.forceRootUpdate()}),a(this,"triggerDependenciesUpdate",function(t,i){var r=e.getDependencyChildrenFields(i);return r.length&&e.validateFields(r),e.notifyObservers(t,r,{type:"dependenciesUpdate",relatedFields:[i].concat(P(r))}),r}),a(this,"updateValue",function(t,i){var r=h.getNamePath(t),n=e.store;e.updateStore(v.default(e.store,r,i)),e.notifyObservers(n,[r],{type:"valueUpdate",source:"internal"}),e.notifyWatch([r]);var o=e.triggerDependenciesUpdate(n,r),l=e.callbacks.onValuesChange;l&&l(h.cloneByNamePathList(e.store,[r]),e.getFieldsValue()),e.triggerOnFieldsChange([r].concat(P(o)))}),a(this,"setFieldsValue",function(t){e.warningUnhooked();var i=e.store;if(t){var r=v.merge(e.store,t);e.updateStore(r)}e.notifyObservers(i,null,{type:"valueUpdate",source:"external"}),e.notifyWatch()}),a(this,"setFieldValue",function(t,i){e.setFields([{name:t,value:i,errors:[],warnings:[]}])}),a(this,"getDependencyChildrenFields",function(t){var i=new Set,r=[],n=new b;return e.getFieldEntities().forEach(function(o){(o.props.dependencies||[]).forEach(function(l){var s=h.getNamePath(l);n.update(s,function(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:new Set;return u.add(o),u})})}),function o(l){(n.get(l)||new Set).forEach(function(s){if(!i.has(s)){i.add(s);var u=s.getNamePath();s.isFieldDirty()&&u.length&&(r.push(u),o(u))}})}(t),r}),a(this,"triggerOnFieldsChange",function(t,i){var r=e.callbacks.onFieldsChange;if(r){var n=e.getFields();if(i){var o=new b;i.forEach(function(s){var u=s.name,g=s.errors;o.set(u,g)}),n.forEach(function(s){s.errors=o.get(s.name)||s.errors})}var l=n.filter(function(s){var u=s.name;return h.containsNamePath(t,u)});l.length&&r(l,n)}}),a(this,"validateFields",function(t,i){var r,n;e.warningUnhooked(),Array.isArray(t)||typeof t=="string"||typeof i=="string"?(r=t,n=i):n=t;var o=!!r,l=o?r.map(h.getNamePath):[],s=[],u=String(Date.now()),g=new Set,p=n||{},y=p.recursive,V=p.dirty;e.getFieldEntities(!0).forEach(function(c){if(o||l.push(c.getNamePath()),c.props.rules&&c.props.rules.length&&(!V||c.isFieldDirty())){var f=c.getNamePath();if(g.add(f.join(u)),!o||h.containsNamePath(l,f,y)){var N=c.validateRules(E({validateMessages:E(E({},K.defaultValidateMessages),e.validateMessages)},n));s.push(N.then(function(){return{name:f,errors:[],warnings:[]}}).catch(function(U){var M,k=[],O=[];return(M=U.forEach)===null||M===void 0||M.call(U,function(L){var D=L.rule.warningOnly,W=L.errors;D?O.push.apply(O,P(W)):k.push.apply(k,P(W))}),k.length?Promise.reject({name:f,errors:k,warnings:O}):{name:f,errors:k,warnings:O}}))}}});var d=B.allPromiseFinish(s);e.lastValidatePromise=d,d.catch(function(c){return c}).then(function(c){var f=c.map(function(N){return N.name});e.notifyObservers(e.store,f,{type:"validateFinish"}),e.triggerOnFieldsChange(f,c)});var w=d.then(function(){return e.lastValidatePromise===d?Promise.resolve(e.getFieldsValue(l)):Promise.reject([])}).catch(function(c){var f=c.filter(function(N){return N&&N.errors.length});return Promise.reject({values:e.getFieldsValue(l),errorFields:f,outOfDate:e.lastValidatePromise!==d})});w.catch(function(c){return c});var I=l.filter(function(c){return g.has(c.join(u))});return e.triggerOnFieldsChange(I),w}),a(this,"submit",function(){e.warningUnhooked(),e.validateFields().then(function(t){var i=e.callbacks.onFinish;if(i)try{i(t)}catch(r){console.error(r)}}).catch(function(t){var i=e.callbacks.onFinishFailed;i&&i(t)})}),this.forceRootUpdate=F});exports.FormStore=q,exports.default=function(m){var F=T.useRef(),e=T.useState({}),t=C(e,2)[1];if(!F.current)if(m)F.current=m;else{var i=new q(function(){t({})});F.current=i.getForm()}return[F.current]};
