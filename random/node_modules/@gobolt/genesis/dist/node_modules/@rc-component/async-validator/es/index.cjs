"use strict";const h=require("../../../@babel/runtime/helpers/esm/objectSpread2.cjs"),O=require("../../../@babel/runtime/helpers/esm/toConsumableArray.cjs"),M=require("../../../@babel/runtime/helpers/esm/typeof.cjs"),R=require("../../../@babel/runtime/helpers/esm/classCallCheck.cjs"),S=require("../../../@babel/runtime/helpers/esm/createClass.cjs"),m=require("../../../@babel/runtime/helpers/esm/defineProperty.cjs"),F=require("./messages.cjs"),y=require("./util.cjs"),E=require("./validator/index.cjs");var q=function(){function v(r){R(this,v),m(this,"rules",null),m(this,"_messages",F.messages),this.define(r)}return S(v,[{key:"define",value:function(r){var u=this;if(!r)throw new Error("Cannot configure a schema with no rules");if(M(r)!=="object"||Array.isArray(r))throw new Error("Rules must be an object");this.rules={},Object.keys(r).forEach(function(i){var a=r[i];u.rules[i]=Array.isArray(a)?a:[a]})}},{key:"messages",value:function(r){return r&&(this._messages=y.deepMerge(F.newMessages(),r)),this._messages}},{key:"validate",value:function(r){var u=this,i=r,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},w=arguments.length>2&&arguments[2]!==void 0?arguments[2]:function(){};if(typeof a=="function"&&(w=a,a={}),!this.rules||Object.keys(this.rules).length===0)return w&&w(null,i),Promise.resolve(i);if(a.messages){var k=this.messages();k===F.messages&&(k=F.newMessages()),y.deepMerge(k,a.messages),a.messages=k}else a.messages=this.messages();var A={};(a.keys||Object.keys(this.rules)).forEach(function(s){var c=u.rules[s],n=i[s];c.forEach(function(e){var t=e;typeof t.transform=="function"&&(i===r&&(i=h({},i)),(n=i[s]=t.transform(n))!=null&&(t.type=t.type||(Array.isArray(n)?"array":M(n)))),(t=typeof t=="function"?{validator:t}:h({},t)).validator=u.getValidationMethod(t),t.validator&&(t.field=s,t.fullField=t.fullField||s,t.type=u.getType(t),A[s]=A[s]||[],A[s].push({rule:t,value:n,source:i,field:s}))})});var C={};return y.asyncMap(A,a,function(s,c){var n,e=s.rule,t=!(e.type!=="object"&&e.type!=="array"||M(e.fields)!=="object"&&M(e.defaultField)!=="object");function j(o,p){return h(h({},p),{},{fullField:"".concat(e.fullField,".").concat(o),fullFields:e.fullFields?[].concat(O(e.fullFields),[o]):[o]})}function l(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],p=Array.isArray(o)?o:[o];!a.suppressWarning&&p.length&&v.warning("async-validator:",p),p.length&&e.message!==void 0&&(p=[].concat(e.message));var d=p.map(y.complementError(e,i));if(a.first&&d.length)return C[e.field]=1,c(d);if(t){if(e.required&&!s.value)return e.message!==void 0?d=[].concat(e.message).map(y.complementError(e,i)):a.error&&(d=[a.error(e,y.format(a.messages.required,e.field))]),c(d);var b={};e.defaultField&&Object.keys(s.value).map(function(g){b[g]=e.defaultField}),b=h(h({},b),s.rule.fields);var x={};Object.keys(b).forEach(function(g){var f=b[g],P=Array.isArray(f)?f:[f];x[g]=P.map(j.bind(null,g))});var _=new v(x);_.messages(a.messages),s.rule.options&&(s.rule.options.messages=a.messages,s.rule.options.error=a.error),_.validate(s.value,s.rule.options||a,function(g){var f=[];d&&d.length&&f.push.apply(f,O(d)),g&&g.length&&f.push.apply(f,O(g)),c(f.length?f:null)})}else c(d)}if(t=t&&(e.required||!e.required&&s.value),e.field=s.field,e.asyncValidator)n=e.asyncValidator(e,s.value,l,s.source,a);else if(e.validator){try{n=e.validator(e,s.value,l,s.source,a)}catch(o){var V,T;(V=(T=console).error)===null||V===void 0||V.call(T,o),a.suppressValidatorError||setTimeout(function(){throw o},0),l(o.message)}n===!0?l():n===!1?l(typeof e.message=="function"?e.message(e.fullField||e.field):e.message||"".concat(e.fullField||e.field," fails")):n instanceof Array?l(n):n instanceof Error&&l(n.message)}n&&n.then&&n.then(function(){return l()},function(o){return l(o)})},function(s){(function(c){for(var n,e,t=[],j={},l=0;l<c.length;l++)n=c[l],e=void 0,Array.isArray(n)?t=(e=t).concat.apply(e,O(n)):t.push(n);t.length?(j=y.convertFieldsError(t),w(t,j)):w(null,i)})(s)},i)}},{key:"getType",value:function(r){if(r.type===void 0&&r.pattern instanceof RegExp&&(r.type="pattern"),typeof r.validator!="function"&&r.type&&!E.hasOwnProperty(r.type))throw new Error(y.format("Unknown rule type %s",r.type));return r.type||"string"}},{key:"getValidationMethod",value:function(r){if(typeof r.validator=="function")return r.validator;var u=Object.keys(r),i=u.indexOf("message");return i!==-1&&u.splice(i,1),u.length===1&&u[0]==="required"?E.required:E[this.getType(r)]||void 0}}]),v}();m(q,"register",function(v,r){if(typeof r!="function")throw new Error("Cannot register a validator by type, validator is not a function");E[v]=r}),m(q,"warning",y.warning),m(q,"messages",F.messages),m(q,"validators",E),module.exports=q;
