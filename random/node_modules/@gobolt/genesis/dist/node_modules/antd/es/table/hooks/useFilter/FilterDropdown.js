import Y from "../../../../../@babel/runtime/helpers/esm/toConsumableArray.js";
import * as l from "react";
import De from "../../../../../@ant-design/icons/es/icons/FilterFilled.js";
import R from "../../../../../../_virtual/index.js";
import Z from "../../../../../rc-util/es/isEqual.js";
import ke from "../../../_util/extendsObject.js";
import Se from "../../../_util/hooks/useSyncState.js";
import { devUseWarning as xe } from "../../../_util/warning.js";
import ee from "../../../button/button.js";
import re from "../../../checkbox/index.js";
import { ConfigContext as Ke } from "../../../config-provider/context.js";
import Fe from "../../../dropdown/index.js";
import te from "../../../empty/index.js";
import Ne from "../../../menu/index.js";
import { OverrideProvider as Oe } from "../../../menu/OverrideContext.js";
import Pe from "../../../radio/index.js";
import Ve from "../../../tree/index.js";
import le from "./FilterSearch.js";
import $e from "./FilterWrapper.js";
function P(d) {
  let o = [];
  return (d || []).forEach((g) => {
    let { value: h, children: f } = g;
    o.push(h), f && (o = [].concat(Y(o), Y(P(f))));
  }), o;
}
function ne(d, o) {
  return (typeof o == "string" || typeof o == "number") && (o == null ? void 0 : o.toString().toLowerCase().includes(d.trim().toLowerCase()));
}
function oe(d) {
  let { filters: o, prefixCls: g, filteredKeys: h, filterMultiple: f, searchValue: a, filterSearch: p } = d;
  return o.map((r, C) => {
    const w = String(r.value);
    if (r.children) return { key: w || C, label: r.text, popupClassName: `${g}-dropdown-submenu`, children: oe({ filters: r.children, prefixCls: g, filteredKeys: h, filterMultiple: f, searchValue: a, filterSearch: p }) };
    const V = f ? re : Pe, s = { key: r.value !== void 0 ? w : C, label: l.createElement(l.Fragment, null, l.createElement(V, { checked: h.includes(w) }), l.createElement("span", null, r.text)) };
    return a.trim() ? typeof p == "function" ? p(a, r) ? s : null : ne(a, r.text) ? s : null : s;
  });
}
function T(d) {
  return d || [];
}
const Ye = (d) => {
  var o, g, h, f;
  const { tablePrefixCls: a, prefixCls: p, column: r, dropdownPrefixCls: C, columnKey: w, filterOnClose: V, filterMultiple: s, filterMode: ie = "menu", filterSearch: E = !1, filterState: m, triggerFilter: ae, locale: c, children: se, getPopupContainer: M, rootClassName: ce } = d, { filterResetToDefaultFilteredValue: j, defaultFilteredValue: A, filterDropdownProps: v = {}, filterDropdownOpen: de, filterDropdownVisible: fe, onFilterDropdownVisibleChange: L, onFilterDropdownOpenChange: _ } = r, [N, pe] = l.useState(!1), z = !(!m || !(!((o = m.filteredKeys) === null || o === void 0) && o.length) && !m.forceFiltered), b = (e) => {
    var t;
    pe(e), (t = v.onOpenChange) === null || t === void 0 || t.call(v, e), _ == null || _(e), L == null || L(e);
  };
  if (process.env.NODE_ENV !== "production") {
    const e = xe("Table");
    [["filterDropdownOpen", "filterDropdownProps.open"], ["filterDropdownVisible", "filterDropdownProps.open"], ["onFilterDropdownOpenChange", "filterDropdownProps.onOpenChange"], ["onFilterDropdownVisibleChange", "filterDropdownProps.onOpenChange"]].forEach((t) => {
      let [n, i] = t;
      e.deprecated(!(n in r), n, i);
    }), e.deprecated(!("filterCheckall" in c), "filterCheckall", "locale.filterCheckAll");
  }
  const G = (f = (h = (g = v.open) !== null && g !== void 0 ? g : de) !== null && h !== void 0 ? h : fe) !== null && f !== void 0 ? f : N, D = m == null ? void 0 : m.filteredKeys, [k, S] = Se(T(D)), x = (e) => {
    let { selectedKeys: t } = e;
    S(t);
  }, me = (e, t) => {
    let { node: n, checked: i } = t;
    x(s ? { selectedKeys: e } : { selectedKeys: i && n.key ? [n.key] : [] });
  };
  l.useEffect(() => {
    N && x({ selectedKeys: T(D) });
  }, [D]);
  const [ue, ge] = l.useState([]), he = (e) => {
    ge(e);
  }, [y, $] = l.useState(""), U = (e) => {
    const { value: t } = e.target;
    $(t);
  };
  l.useEffect(() => {
    N || $("");
  }, [N]);
  const I = (e) => {
    const t = e != null && e.length ? e : null;
    return t !== null || m && m.filteredKeys ? Z(t, m == null ? void 0 : m.filteredKeys, !0) ? null : void ae({ column: r, key: w, filteredKeys: t }) : null;
  }, W = () => {
    b(!1), I(k());
  }, q = function() {
    let { confirm: e, closeDropdown: t } = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : { confirm: !1, closeDropdown: !1 };
    e && I([]), t && b(!1), $(""), S(j ? (A || []).map((n) => String(n)) : []);
  }, ve = function() {
    let { closeDropdown: e } = arguments.length > 0 && arguments[0] !== void 0 ? arguments[0] : { closeDropdown: !0 };
    e && b(!1), I(k());
  }, Ce = R({ [`${C}-menu-without-submenu`]: (B = r.filters || [], !B.some((e) => {
    let { children: t } = e;
    return t;
  })) });
  var B;
  const ye = (e) => {
    if (e.target.checked) {
      const t = P(r == null ? void 0 : r.filters).map((n) => String(n));
      S(t);
    } else S([]);
  }, H = (e) => {
    let { filters: t } = e;
    return (t || []).map((n, i) => {
      const K = String(n.value), F = { title: n.text, key: n.value !== void 0 ? K : String(i) };
      return n.children && (F.children = H({ filters: n.children })), F;
    });
  }, J = (e) => {
    var t;
    return Object.assign(Object.assign({}, e), { text: e.title, value: e.key, children: ((t = e.children) === null || t === void 0 ? void 0 : t.map((n) => J(n))) || [] });
  };
  let u;
  const { direction: we, renderEmpty: Q } = l.useContext(Ke);
  if (typeof r.filterDropdown == "function") u = r.filterDropdown({ prefixCls: `${C}-custom`, setSelectedKeys: (e) => x({ selectedKeys: e }), selectedKeys: k(), confirm: ve, clearFilters: q, filters: r.filters, visible: G, close: () => {
    b(!1);
  } });
  else if (r.filterDropdown) u = r.filterDropdown;
  else {
    const e = k() || [], t = () => {
      var i, K;
      const F = (i = Q == null ? void 0 : Q("Table.filter")) !== null && i !== void 0 ? i : l.createElement(te, { image: te.PRESENTED_IMAGE_SIMPLE, description: c.filterEmptyText, styles: { image: { height: 24 } }, style: { margin: 0, padding: "16px 0" } });
      if ((r.filters || []).length === 0) return F;
      if (ie === "tree") return l.createElement(l.Fragment, null, l.createElement(le, { filterSearch: E, value: y, onChange: U, tablePrefixCls: a, locale: c }), l.createElement("div", { className: `${a}-filter-dropdown-tree` }, s ? l.createElement(re, { checked: e.length === P(r.filters).length, indeterminate: e.length > 0 && e.length < P(r.filters).length, className: `${a}-filter-dropdown-checkall`, onChange: ye }, (K = c == null ? void 0 : c.filterCheckall) !== null && K !== void 0 ? K : c == null ? void 0 : c.filterCheckAll) : null, l.createElement(Ve, { checkable: !0, selectable: !1, blockNode: !0, multiple: s, checkStrictly: !s, className: `${C}-menu`, onCheck: me, checkedKeys: e, selectedKeys: e, showIcon: !1, treeData: H({ filters: r.filters }), autoExpandParent: !0, defaultExpandAll: !0, filterTreeNode: y.trim() ? (O) => typeof E == "function" ? E(y, J(O)) : ne(y, O.title) : void 0 })));
      const X = oe({ filters: r.filters || [], filterSearch: E, prefixCls: p, filteredKeys: k(), filterMultiple: s, searchValue: y }), be = X.every((O) => O === null);
      return l.createElement(l.Fragment, null, l.createElement(le, { filterSearch: E, value: y, onChange: U, tablePrefixCls: a, locale: c }), be ? F : l.createElement(Ne, { selectable: !0, multiple: s, prefixCls: `${C}-menu`, className: Ce, onSelect: x, onDeselect: x, selectedKeys: e, getPopupContainer: M, openKeys: ue, onOpenChange: he, items: X }));
    }, n = () => j ? Z((A || []).map((i) => String(i)), e, !0) : e.length === 0;
    u = l.createElement(l.Fragment, null, t(), l.createElement("div", { className: `${p}-dropdown-btns` }, l.createElement(ee, { type: "link", size: "small", disabled: n(), onClick: () => q() }, c.filterReset), l.createElement(ee, { type: "primary", size: "small", onClick: W }, c.filterConfirm)));
  }
  r.filterDropdown && (u = l.createElement(Oe, { selectable: void 0 }, u)), u = l.createElement($e, { className: `${p}-dropdown` }, u);
  const Ee = ke({ trigger: ["click"], placement: we === "rtl" ? "bottomLeft" : "bottomRight", children: (() => {
    let e;
    return e = typeof r.filterIcon == "function" ? r.filterIcon(z) : r.filterIcon ? r.filterIcon : l.createElement(De, null), l.createElement("span", { role: "button", tabIndex: -1, className: R(`${p}-trigger`, { active: z }), onClick: (t) => {
      t.stopPropagation();
    } }, e);
  })(), getPopupContainer: M }, Object.assign(Object.assign({}, v), { rootClassName: R(ce, v.rootClassName), open: G, onOpenChange: (e, t) => {
    t.source === "trigger" && (e && D !== void 0 && S(T(D)), b(e), e || r.filterDropdown || !V || W());
  }, dropdownRender: () => typeof (v == null ? void 0 : v.dropdownRender) == "function" ? v.dropdownRender(u) : u }));
  return l.createElement("div", { className: `${p}-column` }, l.createElement("span", { className: `${a}-column-title` }, se), l.createElement(Fe, Object.assign({}, Ee)));
};
export {
  Ye as default,
  P as flattenKeys
};
