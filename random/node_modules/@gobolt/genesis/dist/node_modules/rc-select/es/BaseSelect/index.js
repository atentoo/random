import Oe from "../../../@babel/runtime/helpers/esm/extends.js";
import p from "../../../@babel/runtime/helpers/esm/defineProperty.js";
import Ro from "../../../@babel/runtime/helpers/esm/toConsumableArray.js";
import E from "../../../@babel/runtime/helpers/esm/slicedToArray.js";
import $ from "../../../@babel/runtime/helpers/esm/objectSpread2.js";
import Do from "../../../@babel/runtime/helpers/esm/objectWithoutProperties.js";
import Ae from "../../../../_virtual/index.js";
import Po from "../../../rc-util/es/hooks/useLayoutEffect.js";
import No from "../../../rc-util/es/hooks/useMergedState.js";
import Mo from "../../../rc-util/es/isMobile.js";
import { useComposeRef as Oo } from "../../../rc-util/es/ref.js";
import * as n from "react";
import { useAllowClear as Ao } from "../hooks/useAllowClear.js";
import { BaseSelectContext as To } from "../hooks/useBaseProps.js";
import ko from "../hooks/useDelayReset.js";
import Ko from "../hooks/useLock.js";
import Fo from "../hooks/useSelectTriggerControl.js";
import Bo from "../Selector/index.js";
import zo from "../SelectTrigger.js";
import Uo from "../TransBtn.js";
import { isValidCount as Te, getSeparatedContent as Wo } from "../utils/valueUtil.js";
import Lo from "../SelectContext.js";
import jo from "./Polite.js";
var Ho = ["id", "prefixCls", "className", "showSearch", "tagRender", "direction", "omitDomProps", "displayValues", "onDisplayValuesChange", "emptyOptions", "notFoundContent", "onClear", "mode", "disabled", "loading", "getInputElement", "getRawInputElement", "open", "defaultOpen", "onDropdownVisibleChange", "activeValue", "onActiveValueChange", "activeDescendantId", "searchValue", "autoClearSearchValue", "onSearch", "onSearchSplit", "tokenSeparators", "allowClear", "prefix", "suffixIcon", "clearIcon", "OptionList", "animation", "transitionName", "dropdownStyle", "dropdownClassName", "dropdownMatchSelectWidth", "dropdownRender", "dropdownAlign", "placement", "builtinPlacements", "getPopupContainer", "showAction", "onFocus", "onBlur", "onKeyUp", "onKeyDown", "onMouseDown"], _o = ["value", "onChange", "removeIcon", "placeholder", "autoFocus", "maxTagCount", "maxTagTextLength", "maxTagPlaceholder", "choiceTransitionName", "onInputKeyDown", "onPopupScroll", "tabIndex"], qo = function(e) {
  return e === "tags" || e === "multiple";
}, Go = n.forwardRef(function(e, ke) {
  var k, K = e.id, u = e.prefixCls, Ke = e.className, V = e.showSearch, Fe = e.tagRender, Be = e.direction, ee = e.omitDomProps, d = e.displayValues, F = e.onDisplayValuesChange, oe = e.emptyOptions, ne = e.notFoundContent, B = ne === void 0 ? "Not Found" : ne, te = e.onClear, i = e.mode, s = e.disabled, D = e.loading, re = e.getInputElement, ae = e.getRawInputElement, ze = e.open, Ue = e.defaultOpen, z = e.onDropdownVisibleChange, We = e.activeValue, ue = e.onActiveValueChange, Le = e.activeDescendantId, le = e.searchValue, je = e.autoClearSearchValue, x = e.onSearch, ie = e.onSearchSplit, U = e.tokenSeparators, ce = e.allowClear, He = e.prefix, se = e.suffixIcon, _e = e.clearIcon, qe = e.OptionList, Ge = e.animation, Je = e.transitionName, Qe = e.dropdownStyle, Xe = e.dropdownClassName, Ye = e.dropdownMatchSelectWidth, Ze = e.dropdownRender, $e = e.dropdownAlign, Ve = e.placement, eo = e.builtinPlacements, oo = e.getPopupContainer, pe = e.showAction, no = pe === void 0 ? [] : pe, me = e.onFocus, de = e.onBlur, fe = e.onKeyUp, ve = e.onKeyDown, ge = e.onMouseDown, to = Do(e, Ho), h = qo(i), I = (V !== void 0 ? V : h) || i === "combobox", W = $({}, to);
  _o.forEach(function(o) {
    delete W[o];
  }), ee == null || ee.forEach(function(o) {
    delete W[o];
  });
  var ro = n.useState(!1), he = E(ro, 2), ao = he[0], uo = he[1];
  n.useEffect(function() {
    uo(Mo());
  }, []);
  var L = n.useRef(null), P = n.useRef(null), j = n.useRef(null), R = n.useRef(null), N = n.useRef(null), H = n.useRef(!1), lo = ko(), _ = E(lo, 3), q = _[0], G = _[1], io = _[2];
  n.useImperativeHandle(ke, function() {
    var o, t;
    return { focus: (o = R.current) === null || o === void 0 ? void 0 : o.focus, blur: (t = R.current) === null || t === void 0 ? void 0 : t.blur, scrollTo: function(c) {
      var r;
      return (r = N.current) === null || r === void 0 ? void 0 : r.scrollTo(c);
    }, nativeElement: L.current || P.current };
  });
  var w = n.useMemo(function() {
    var o;
    if (i !== "combobox") return le;
    var t = (o = d[0]) === null || o === void 0 ? void 0 : o.value;
    return typeof t == "string" || typeof t == "number" ? String(t) : "";
  }, [le, i, d]), we = i === "combobox" && typeof re == "function" && re() || null, y = typeof ae == "function" && ae(), co = Oo(P, y == null || (k = y.props) === null || k === void 0 ? void 0 : k.ref), so = n.useState(!1), ye = E(so, 2), po = ye[0], mo = ye[1];
  Po(function() {
    mo(!0);
  }, []);
  var fo = No(!1, { defaultValue: Ue, value: ze }), Ce = E(fo, 2), be = Ce[0], J = Ce[1], a = !!po && be, Se = !B && oe;
  (s || Se && a && i === "combobox") && (a = !1);
  var M = !Se && a, f = n.useCallback(function(o) {
    var t = o !== void 0 ? o : !a;
    s || (J(t), a !== t && (z == null || z(t)));
  }, [s, a, J, z]), vo = n.useMemo(function() {
    return (U || []).some(function(o) {
      return [`
`, `\r
`].includes(o);
    });
  }, [U]), Ee = n.useContext(Lo) || {}, O = Ee.maxCount, Q = Ee.rawValues, X = function(o, t, c) {
    if (!(h && Te(O) && (Q == null ? void 0 : Q.size) >= O)) {
      var r = !0, l = o;
      ue == null || ue(null);
      var m = Wo(o, U, Te(O) ? O - Q.size : void 0), v = c ? null : m;
      return i !== "combobox" && v && (l = "", ie == null || ie(v), f(!1), r = !1), x && w !== l && x(l, { source: t ? "typing" : "effect" }), r;
    }
  };
  n.useEffect(function() {
    a || h || i === "combobox" || X("", !1, !1);
  }, [a]), n.useEffect(function() {
    be && s && J(!1), s && !H.current && G(!1);
  }, [s]);
  var go = Ko(), xe = E(go, 2), ho = xe[0], wo = xe[1], A = n.useRef(!1), Y = n.useRef(!1), C = [];
  n.useEffect(function() {
    return function() {
      C.forEach(function(o) {
        return clearTimeout(o);
      }), C.splice(0, C.length);
    };
  }, []);
  var Ie, yo = n.useState({}), Co = E(yo, 2)[1];
  y && (Ie = function(o) {
    f(o);
  }), Fo(function() {
    var o;
    return [L.current, (o = j.current) === null || o === void 0 ? void 0 : o.getPopupElement()];
  }, M, f, !!y);
  var Re, bo = n.useMemo(function() {
    return $($({}, e), {}, { notFoundContent: B, open: a, triggerOpen: M, id: K, showSearch: I, multiple: h, toggleOpen: f });
  }, [e, B, M, a, K, I, h, f]), De = !!se || D;
  De && (Re = n.createElement(Uo, { className: Ae("".concat(u, "-arrow"), p({}, "".concat(u, "-arrow-loading"), D)), customizeIcon: se, customizeIconProps: { loading: D, searchValue: w, open: a, focused: q, showSearch: I } }));
  var Pe, Ne = Ao(u, function() {
    var o;
    te == null || te(), (o = R.current) === null || o === void 0 || o.focus(), F([], { type: "clear", values: d }), X("", !1, !1);
  }, d, ce, _e, s, w, i), So = Ne.allowClear, Eo = Ne.clearIcon, xo = n.createElement(qe, { ref: N }), Io = Ae(u, Ke, p(p(p(p(p(p(p(p(p(p({}, "".concat(u, "-focused"), q), "".concat(u, "-multiple"), h), "".concat(u, "-single"), !h), "".concat(u, "-allow-clear"), ce), "".concat(u, "-show-arrow"), De), "".concat(u, "-disabled"), s), "".concat(u, "-loading"), D), "".concat(u, "-open"), a), "".concat(u, "-customize-input"), we), "".concat(u, "-show-search"), I)), Me = n.createElement(zo, { ref: j, disabled: s, prefixCls: u, visible: M, popupElement: xo, animation: Ge, transitionName: Je, dropdownStyle: Qe, dropdownClassName: Xe, direction: Be, dropdownMatchSelectWidth: Ye, dropdownRender: Ze, dropdownAlign: $e, placement: Ve, builtinPlacements: eo, getPopupContainer: oo, empty: oe, getTriggerDOMNode: function(o) {
    return P.current || o;
  }, onPopupVisibleChange: Ie, onPopupMouseEnter: function() {
    Co({});
  } }, y ? n.cloneElement(y, { ref: co }) : n.createElement(Bo, Oe({}, e, { domRef: P, prefixCls: u, inputElement: we, ref: R, id: K, prefix: He, showSearch: I, autoClearSearchValue: je, mode: i, activeDescendantId: Le, tagRender: Fe, values: d, open: a, onToggleOpen: f, activeValue: We, searchValue: w, onSearch: X, onSearchSubmit: function(o) {
    o && o.trim() && x(o, { source: "submit" });
  }, onRemove: function(o) {
    var t = d.filter(function(c) {
      return c !== o;
    });
    F(t, { type: "remove", values: [o] });
  }, tokenWithEnter: vo, onInputBlur: function() {
    A.current = !1;
  } })));
  return Pe = y ? Me : n.createElement("div", Oe({ className: Io }, W, { ref: L, onMouseDown: function(o) {
    var t, c = o.target, r = (t = j.current) === null || t === void 0 ? void 0 : t.getPopupElement();
    if (r && r.contains(c)) {
      var l = setTimeout(function() {
        var b, S = C.indexOf(l);
        S !== -1 && C.splice(S, 1), io(), ao || r.contains(document.activeElement) || (b = R.current) === null || b === void 0 || b.focus();
      });
      C.push(l);
    }
    for (var m = arguments.length, v = new Array(m > 1 ? m - 1 : 0), g = 1; g < m; g++) v[g - 1] = arguments[g];
    ge == null || ge.apply(void 0, [o].concat(v));
  }, onKeyDown: function(o) {
    var t, c = ho(), r = o.key, l = r === "Enter";
    if (l && (i !== "combobox" && o.preventDefault(), a || f(!0)), wo(!!w), r === "Backspace" && !c && h && !w && d.length) {
      for (var m = Ro(d), v = null, g = m.length - 1; g >= 0; g -= 1) {
        var b = m[g];
        if (!b.disabled) {
          m.splice(g, 1), v = b;
          break;
        }
      }
      v && F(m, { type: "remove", values: [v] });
    }
    for (var S = arguments.length, Z = new Array(S > 1 ? S - 1 : 0), T = 1; T < S; T++) Z[T - 1] = arguments[T];
    !a || l && A.current || (l && (A.current = !0), (t = N.current) === null || t === void 0 || t.onKeyDown.apply(t, [o].concat(Z))), ve == null || ve.apply(void 0, [o].concat(Z));
  }, onKeyUp: function(o) {
    for (var t = arguments.length, c = new Array(t > 1 ? t - 1 : 0), r = 1; r < t; r++) c[r - 1] = arguments[r];
    var l;
    a && ((l = N.current) === null || l === void 0 || l.onKeyUp.apply(l, [o].concat(c))), o.key === "Enter" && (A.current = !1), fe == null || fe.apply(void 0, [o].concat(c));
  }, onFocus: function() {
    G(!0), s || (me && !Y.current && me.apply(void 0, arguments), no.includes("focus") && f(!0)), Y.current = !0;
  }, onBlur: function() {
    H.current = !0, G(!1, function() {
      Y.current = !1, H.current = !1, f(!1);
    }), s || (w && (i === "tags" ? x(w, { source: "submit" }) : i === "multiple" && x("", { source: "blur" })), de && de.apply(void 0, arguments));
  } }), n.createElement(jo, { visible: q && !a, values: d }), Me, Re, So && Eo), n.createElement(To.Provider, { value: bo }, Pe);
});
process.env.NODE_ENV !== "production" && (Go.displayName = "BaseSelect");
export {
  Go as default,
  qo as isMultiple
};
